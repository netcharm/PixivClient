<Page x:Class="PixivWPF.Pages.TilesPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:PixivWPF.Pages"
      xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
      xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
      xmlns:Common="clr-namespace:PixivWPF.Common"
      mc:Ignorable="d"
      VisualTextRenderingMode="Auto"
      RenderOptions.BitmapScalingMode="HighQuality"
      RenderOptions.CachingHint="Cache"
      RenderOptions.ClearTypeHint="Enabled"
      RenderOptions.EdgeMode="Aliased"
      TextOptions.TextFormattingMode="Display"
      AllowDrop="True"
      d:DesignHeight="700" d:DesignWidth="1420"
      Title="Image Master Detail Viewer">

    <Page.Resources>
        <CollectionViewSource x:Key="ActiveImageTiles" Source="{Binding local:ImageList, Mode=OneWay, IsAsync=True}" Filter="OnlyActiveItems"/>
        
        <DataTemplate x:Key="ImageTileTemplate" x:Name="ImageTile" x:Uid="ImageTile">
            <StackPanel>
                <Grid Background="{DynamicResource AccentColorBrush}" 
                      ToolTip="{Binding ToolTip, Mode=OneWay}"
                      Width="128" Tag="{Binding Path='', Mode=OneWay}" Margin="0,4,0,4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="128"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" x:Name="PART_Mask" Opacity="0.67"
                            HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                            Background="{DynamicResource IdealForegroundColorBrush}" BorderBrush="{DynamicResource AccentColorBrush}"/>
                    <mah:ProgressRing Grid.Row="0" x:Name="PART_Progress"
                                      Width="72" Height="72" Opacity="0.67" 
                                      HorizontalAlignment="Center" VerticalAlignment="Center"                         
                                      Foreground="{DynamicResource AccentColorBrush}"/>
                    <Image Grid.Row="0" x:Name="PART_Thumbnail"
                           Source="{Binding Source, Mode=OneWay, IsAsync=True, NotifyOnTargetUpdated=True}"
                           TargetUpdated="TileImage_TargetUpdated"
                           Tag="{Binding Illust, Mode=OneWay}"
                           Stretch="Uniform" Width="128" Height="128"
                           HorizontalAlignment="Center" VerticalAlignment="Center">
                    </Image>
                    <iconPacks:PackIconModern 
                        Grid.Row="0"
                        Kind="Heart" 
                        Width="28" Height="24" Margin="0,0,6,8" 
                        Foreground="{DynamicResource IdealForegroundColorBrush}" 
                        HorizontalAlignment="Right" VerticalAlignment="Bottom" 
                        Visibility="{Binding FavMarkVisibility, Mode=OneWay}" >
                        <iconPacks:PackIconModern.Effect>
                            <DropShadowEffect ShadowDepth="0" Color="{DynamicResource IdealForegroundColor}" Opacity="1" BlurRadius="9"/>
                        </iconPacks:PackIconModern.Effect>
                    </iconPacks:PackIconModern>
                    <iconPacks:PackIconModern 
                        Grid.Row="0" x:Name="PART_Favorite" 
                        Kind="Heart" 
                        Width="24" Height="24" Margin="0,0,8,8" 
                        Foreground="{DynamicResource AccentColorBrush}" 
                        HorizontalAlignment="Right" VerticalAlignment="Bottom" 
                        Visibility="{Binding FavMarkVisibility, Mode=OneWay, NotifyOnTargetUpdated=True}"
                        TargetUpdated="TileImage_TargetUpdated">
                        <iconPacks:PackIconModern.Effect>
                            <DropShadowEffect ShadowDepth="0" Color="{DynamicResource IdealForegroundColor}" Opacity="1" BlurRadius="5"/>
                        </iconPacks:PackIconModern.Effect>
                    </iconPacks:PackIconModern>
                    <iconPacks:PackIconModern 
                        Grid.Row="0" x:Name="PART_Follow" 
                        Kind="Check"
                        Width="16" Height="16" Margin="0,0,12,12" 
                        HorizontalAlignment="Right" VerticalAlignment="Bottom" 
                        Foreground="{DynamicResource IdealForegroundColorBrush}"
                        Visibility="{Binding FollowMarkVisibility, Mode=OneWay, NotifyOnTargetUpdated=True}" 
                        TargetUpdated="TileImage_TargetUpdated">
                        <iconPacks:PackIconModern.Effect>
                            <DropShadowEffect x:Name="PART_Follow_Shadow" ShadowDepth="0" Color="{DynamicResource AccentColor}" Opacity="1" BlurRadius="10"/>
                        </iconPacks:PackIconModern.Effect>
                    </iconPacks:PackIconModern>
                    <mah:Badged Grid.Row="0" 
                                Badge="{Binding BadgeValue, Mode=OneWay}" 
                                BadgePlacementMode="TopRight" Margin="0,16,16,0"
                                FontSize="16" FontFamily="Consolas" 
                                Visibility="{Binding BadgeVisibility, Mode=OneWay}"
                                BadgeBackground="{DynamicResource AccentColorBrush}" />
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" 
                                   Text="{Binding Subject, Mode=OneWay}" 
                                   Background="{DynamicResource AccentColorBrush}"
                                   Foreground="{DynamicResource IdealForegroundColorBrush}"/>
                        <iconPacks:PackIconModern Grid.Column="1" 
                                                  Kind="Download" x:Name="PART_IllustDownloaded" 
                                                  Width="16" Height="16"
                                                  HorizontalAlignment="Center" VerticalAlignment="Center"
                                                  SourceUpdated="TileImage_TargetUpdated"
                                                  Background="{DynamicResource AccentColorBrush}"
                                                  Foreground="{DynamicResource IdealForegroundColorBrush}"
                                                  Tag="{Binding IsDownloaded, Mode=OneWay, NotifyOnSourceUpdated=True}"
                                                  Visibility="{Binding IsDownloadedVisibility, Mode=OneWay}"/>
                    </Grid>
                </Grid>
            </StackPanel>
        </DataTemplate>

        <!--<ContextMenu x:Key="ActionsMenu">
            <MenuItem x:Name="ActionOpenIllustSet" x:Uid="ActionOpenIllustSet" Header="Open Illust Set" Visibility="Collapsed" Click="ActionOpenIllustSet_Click"/>
            <MenuItem x:Name="ActionIllustUserInfo" x:Uid="ActionIllustUserInfo" Header="Author Info" Visibility="Collapsed" Click="ActionIllustUserInfo_Click"/>
            <MenuItem x:Name="ActionIllustRelative" x:Uid="ActionIllustRelative" Header="Relative Illust" Click="ActionIllustRelative_Click"/>
            <Separator />
            <MenuItem x:Name="ActionSaveIllust" x:Uid="ActionSaveIllust" Header="Save Illust" Click="ActionSaveIllust_Click"/>
        </ContextMenu>-->
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" MinWidth="694"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <!-- Illust List Viewport -->
        <!--<ScrollViewer Grid.Column="0" x:Name="ImageTilesViewer" ScrollChanged="ImageTilesViewer_ScrollChanged" >-->
        <!--<Expander Grid.Column="0" ExpandDirection="Right" IsExpanded="True" HorizontalAlignment="Left">-->
            <ListView Grid.Column="0"
                      x:Name="ListImageTiles" x:Uid="ImageTiles"
                      BorderBrush="Transparent"
                      HorizontalAlignment="Center" VerticalAlignment="Top" Margin="4"
                      IsSynchronizedWithCurrentItem="true"
                      ItemsSource="{Binding Source={StaticResource ActiveImageTiles}, IsAsync=True, NotifyOnTargetUpdated=True}" 
                      ItemTemplate="{DynamicResource ImageTileTemplate}"
                      ScrollViewer.IsDeferredScrollingEnabled="False"
                      SelectionMode="Single"
                      Style="{DynamicResource VirtualisedMetroListView}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.IsContainerVirtualizable="True"
                      VirtualizingPanel.IsVirtualizingWhenGrouping="True"
                      VirtualizingPanel.CacheLength ="150"
                      VirtualizingPanel.CacheLengthUnit="Item"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      VirtualizingPanel.ScrollUnit="Item"
                      mah:ScrollViewerHelper.IsHorizontalScrollWheelEnabled="True" 
                      KeyDown="ListImageTiles_KeyDown"                      
                      MouseDoubleClick="ListImageTiles_MouseDoubleClick"
                      MouseDown="ListImageTiles_MouseDown"
                      PreviewMouseWheel="ListImageTiles_PreviewMouseWheel"
                      SelectionChanged="ImageTiles_SelectionChanged">
                <ListView.CacheMode>
                    <BitmapCache EnableClearType="True" SnapsToDevicePixels="True"/>
                </ListView.CacheMode>
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <!--<WrapPanel ItemWidth="136" MinWidth="600"/>-->
                        <!--<auxc:UniformGridPanel Orientation="Vertical" Columns="5" Rows="5" Width="700" Height="Auto">
                        
                    </auxc:UniformGridPanel>-->

                        <!--<vwp:VirtualizingTilePanel Columns="5" ChildHeight="152" MinChildWidth="128">

                    </vwp:VirtualizingTilePanel>-->

                        <UniformGrid Columns="5" Grid.IsSharedSizeScope="True" 
                                 HorizontalAlignment="Center" VerticalAlignment="Top" 
                                 ScrollViewer.CanContentScroll="True" UseLayoutRounding="True">
                            <UniformGrid.CacheMode>
                                <BitmapCache EnableClearType="True" SnapsToDevicePixels="True"/>
                            </UniformGrid.CacheMode>
                        </UniformGrid>
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
            </ListView>
        <!--</ScrollViewer>-->
        <!--</Expander>-->
        <mah:ProgressRing Grid.Column="0" 
                          x:Name="ImageTilesWait" 
                          Width="128" Height="128" 
                          Foreground="{DynamicResource AccentColorBrush}"
                          Opacity="0.9" Visibility="Hidden"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>

        <!-- Illust Preview Viewport -->
        <Frame Grid.Column="1" Margin="4" x:Name="IllustDetail" x:Uid="IllustDetail"/>
        
    </Grid>

</Page>
